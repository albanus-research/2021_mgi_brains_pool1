---
title: "Seurat first-pass"
output:
  html_document:
    theme: readable
    df_print: paged
    code_folding: hide
    toc: true
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
options(stringsAsFactors = F)
seed <- 87532163

library(knitr)
library(ggplot2)
library(RColorBrewer)
library(dplyr)
library(tidyr)
library(scales)
library(glue)

library(Matrix)
library(Seurat)

# source("~/scripts/R_rainclouds.R")

knitr::opts_knit$set(root.dir = "/home/dricardo/work/2021_mgi_brains_pool1")
knitr::opts_chunk$set(fig.width = 4, fig.height = 4, fig.show = "hold")

options(dplyr.summarise.inform = FALSE)  # Disable "`summarise()` has grouped output by 'foo'" message

theme_set(theme_bw(base_size = 12))
```

```{r}
qc <- data.table::fread("work/seurat/barcode_metrics.tsv.gz", header = T, data.table = F) %>% 
  mutate(barcode  = case_when(pool == "pool2" ~ gsub("-1$", "-2", barcode), 
                              T ~ barcode)) 
```


```{r}
demux <- lapply(1:16, function(i) {
  read.table(
    glue("work/demuxlet_rm_singletons_only/output_by_batch/demux_batch.{i}_16.best"), header = T, sep ="\t"
  )
}) %>% 
  bind_rows() %>% 
  mutate(pool = "pool1") %>% 
  rename(barcode = BARCODE)

demux2 <- lapply(1:14, function(i) {
  read.table(
    glue("../2021_mgi_brains_pool2/work/demuxlet_rm_singletons_only/output_by_batch/demux_batch.{i}_14.best"), 
    header = T, sep ="\t"
  )
}) %>% 
  bind_rows() %>% 
  mutate(pool = "pool2") %>% 
  rename(barcode = BARCODE) %>% 
  mutate(barcode = gsub("-1$", "-2", barcode))

demux <- bind_rows(demux, demux2) %>% 
  select(barcode, pool, BEST) %>% 
  mutate(demuxlet_call = gsub("-.*", "", BEST)) %>% 
  mutate(primary_sample = gsub("\\^.*", "", BEST)) %>% 
  mutate(primary_sample = gsub(".*-", "", primary_sample)) %>% 
  mutate(primary_sample = case_when(demuxlet_call != "SNG" ~ demuxlet_call, 
                                    T ~ primary_sample))
rm(demux2)
```

```{r}
md <- qc %>% 
  inner_join(demux, by = c("barcode", "pool")) %>% 
  filter(nUMI > 1000, pctMT < 0.2, cellranger_nuclei, demuxlet_call == "SNG")
rownames(md) <- md$barcode

barcodes_to_keep <- md$barcode

table(qc$barcode %in% barcodes_to_keep, qc$pool)
```

```{r}
# indir1 <- "work/cellranger_gex/outs/filtered_feature_bc_matrix"
# indir2 <- file.path("../2021_mgi_brains_pool2", indir1)
# 
# read_raw_counts <- function(indir) {
#   bc <- read.table(file.path(indir, "barcodes.tsv.gz"))[,1]
#   features <- read.table(file.path(indir, "features.tsv.gz"))[,2]
#   mat <- readMM(file.path(indir, "matrix.mtx.gz"))
#   colnames(mat) <- bc
#   rownames(mat) <- features
#   return(mat)
# }
# 
# m1 <- read_raw_counts(indir1)
# m1 <- m1[, which(colnames(m1) %in% barcodes_to_keep)]
# m2 <- read_raw_counts(indir2)
# colnames(m2) <- gsub("-1$", "-2", colnames(m2))
# m2 <- m2[, which(colnames(m2) %in% barcodes_to_keep)]
# 
# dim(m1)
# dim(m2)
# 
# sobjs <- list(m1, m2) %>%
#   lapply(function(i) {
#     sobj <- CreateSeuratObject(counts = i, meta.data = md)
#     sobj <- PercentageFeatureSet(sobj, pattern = "^MT-", col.name = "percent.mt")
#     sobj <- suppressWarnings(SCTransform(sobj, vars.to.regress = "percent.mt"))
#     sobj <- RunPCA(sobj)
#     sobj <- RunUMAP(sobj, dims = 1:30)
#     sobj <- FindNeighbors(sobj, dims = 1:30)
#     sobj <- FindClusters(sobj)
#   })

# saveRDS(sobjs, file = "work/seurat/preprocessed_sobjs.rds")
# saveRDS(sobjs, file = "work/seurat/preprocessed_sobjs.no_dbls.rds")
sobjs <- readRDS("work/seurat/preprocessed_sobjs.rds")

sobjs
```


```{r, fig.width=5}
1:2 %>% 
  lapply(function(i) {
    DimPlot(sobjs[[i]], label = TRUE) + NoLegend() +
      ggtitle(glue("Pool {i}"))
  })
```




```{r, fig.width=5}
1:2 %>% 
  lapply(function(i) {
    DimPlot(sobjs[[i]], group.by = "demuxlet_call") +
      ggtitle(glue("Pool {i}")) 
  })

1:2 %>% 
  lapply(function(i) {
    DimPlot(sobjs[[i]], group.by = "primary_sample") +
      ggtitle(glue("Pool {i}")) 
  })
```

```{r, fig.width=6, fig.height=6}
1:2 %>% 
  lapply(function(i) {
    DimPlot(sobjs[[i]], group.by = "primary_sample", ) +
      ggtitle(glue("Pool {i}")) +
      facet_wrap(~ primary_sample) +
      NoLegend()
  })
```


```{r, fig.height=6, fig.width=20}
marker_genes <- list(
  OPCs = c(
    'TNR','PDGFRA' #'CNTN1'
    ),
  Oligos = c(
    'QDPR','TULP4','PIP4K2A','TMEM144','SLC44A1','CNP','SLAIN1','ANLN','MOBP',
    'SCD','CNDP1','MBP','ERMN','CLDND1','UGT8','TTLL7','SLC24A2','ENPP2','TF',
    'PLP1',
    "MOG",'OPALIN','SEPT4'
    ), 
  Neurons = c(  
    'PCLO','GABRA1','SCG2','UCHL1','GABRB2','GAD1','VSNL1','STMN2','RTN1',
    'SNAP25','SYT1','SCN2A','DLX6-AS1','SYNPR',
    'CNR1','RELN'
    ), 
  Neurons_exc = c(
    "RALYL", "KCNIP4", "CBLN2", "LDB2", "KCNQ5",
    "SCL17A7", "SATB2"
  ),
  Neurons_inh = c(
    "NXPH1", "LHFPL3", "PCDH15", "GRIK1", "ADARB2",
    "GAD2"
  ),
  Microglia = c(
    'C3','CCL4','MSR1','OLR1','GPR183','CD53','LCP1','HAVCR2','LHFPL2','PLEK',
    'HLA-DRA','CD74','CX3CR1','C3AR1','CLEC7A','B3GNT5',
    'CD83','IL1B','CH25H',
    "CSF1R", "P2RY12"
    ),
  Endothelial = c(
    'NET1','FN1','APOLD1','TM4SF1','ABCG2','RGS5','DCN',
    "VWF"
  ),
  Astrocytes = c(
    'SLCO1C1','ATP1B2','CPE','AQP4','EDNRB','SLC4A4','GJA1','SLC1A2','CLU',
    'ETNPPL','F3','RYR3',
    'DIO2','GPR37L1',
    "PDGFRA", # Also in OPCs
    "CSPG4", "GFAP"
  )
)


DotPlot(sobjs[[1]], features = unlist(marker_genes) %>% unique()) + 
  RotatedAxis() +
  ggtitle("Pool1")

DotPlot(sobjs[[2]], features = unlist(marker_genes) %>% unique()) + 
  RotatedAxis() +
  ggtitle("Pool2")
```

```{r, fig.height=6, fig.width=7}
marker_genes %>% 
  names() %>% 
  lapply(function(i) {
    DotPlot(sobjs[[1]], features = marker_genes[[i]]) + 
      RotatedAxis() +
      ggtitle(glue("Pool1: {i}"))    
  })
```

```{r, fig.height=6, fig.width=7}
marker_genes %>% 
  names() %>% 
  lapply(function(i) { 
    DotPlot(sobjs[[2]], features = marker_genes[[i]]) + 
      RotatedAxis() +
      ggtitle(glue("Pool2: {i}"))    
  })
```
